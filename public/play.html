<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé∞ Claw Machine</title>
    <link rel="stylesheet" href="games/claw-machine.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .game-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
        }
        
        .game-header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        #claw-game-container {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .prize-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 30px 50px;
            border-radius: 15px;
            z-index: 10001;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            text-align: center;
            animation: prizePopIn 0.5s ease;
        }
        
        @keyframes prizePopIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-screen h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-screen {
            text-align: center;
            padding: 40px;
        }
        
        .error-screen h2 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        .error-screen p {
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .error-screen a {
            color: #3498db;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-screen">
        <h2>üé∞ Loading Claw Machine...</h2>
        <div class="loading-spinner"></div>
    </div>
    
    <div id="error" class="error-screen" style="display: none;">
        <h2>‚ùå Access Required</h2>
        <p>You need a valid session to play the claw machine.</p>
        <p>Use the <code>/clawmachine</code> command in Discord to start a session!</p>
    </div>
    
    <div id="game-content" style="display: none;">
        <div class="game-header">
            <h1>üé∞ Claw Machine</h1>
            <p>Grab a prize and it's yours!</p>
        </div>
        
        <div id="claw-game-container"></div>
        
        <button id="end-game-btn" onclick="endGame()" style="
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 16px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            üõë End Game
        </button>
    </div>
    
    <script src="games/claw-machine.js"></script>
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');
        const userId = urlParams.get('user');
        
        let clawMachineInstance = null;
        let prizesWon = [];
        let settings = null;
        let items = {};
        let triesRemaining = 0;
        let maxTries = 5;
        let glowRarities = {};
        let isFirstGrab = true;
        
        // Initialize the game
        async function init() {
            // Validate session
            if (!sessionId || !userId) {
                showError();
                return;
            }
            
            try {
                // Load settings from server
                const settingsRes = await fetch('/api/games/claw-settings');
                if (settingsRes.ok) {
                    settings = await settingsRes.json();
                }
                
                // Get tries info
                const triesRes = await fetch(`/api/claw-machine/tries/${userId}`);
                if (triesRes.ok) {
                    const triesData = await triesRes.json();
                    triesRemaining = triesData.triesRemaining;
                    maxTries = triesData.maxTries;
                    updateTriesDisplay();
                }
                
                // Load items from server
                const itemsRes = await fetch('/api/items');
                if (itemsRes.ok) {
                    const itemsData = await itemsRes.json();
                    items = itemsData.items || itemsData || {};
                }
                
                // Get prizes based on settings
                const prizes = getPrizes();
                
                if (prizes.length === 0) {
                    console.warn('No prizes available');
                }
                
                // Hide loading, show game
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game-content').style.display = 'block';
                
                // Get gameplay settings - use server-side try tracking
                const gameplayOptions = {
                    prizes,
                    clawStrength: settings?.gameplay?.clawStrength || 70,
                    dropChance: settings?.gameplay?.dropChance || 20,
                    maxTries: 0  // Disable client-side limit, we track on server
                };
                
                console.log('Initializing with gameplay settings:', gameplayOptions);
                
                // Initialize claw machine
                clawMachineInstance = initClawMachine('claw-game-container', gameplayOptions);
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                showError();
            }
        }
        
        function updateTriesDisplay() {
            const header = document.querySelector('.game-header p');
            if (header) {
                header.textContent = `üéÆ ${triesRemaining}/${maxTries} tries remaining today`;
            }
        }
        
        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }
        
        function getPrizes() {
            let prizes = [];
            
            // Get selected categories and rarities from settings
            const selectedCategories = settings?.prizes?.selectedCategories || ['all'];
            const selectedRarities = settings?.prizes?.selectedRarities || ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic'];
            const allCategoriesSelected = selectedCategories.includes('all') || selectedCategories.length === 0;
            
            Object.entries(items).forEach(([itemId, item]) => {
                const itemCategory = item.category || item.categoryId || '';
                const categoryMatch = allCategoriesSelected || selectedCategories.includes(itemCategory);
                const rarityMatch = selectedRarities.includes(item.rarity || 'common');
                
                if (categoryMatch && rarityMatch) {
                    let imageUrl = item.imageUrl || item.image || '';
                    
                    if (!imageUrl && item.emoji) {
                        const match = item.emoji.match(/<a?:[^:]+:(\d+)>/);
                        if (match) {
                            const isAnimated = item.emoji.startsWith('<a:');
                            imageUrl = `https://cdn.discordapp.com/emojis/${match[1]}.${isAnimated ? 'gif' : 'png'}?size=128`;
                        }
                    }
                    
                    prizes.push({
                        id: itemId,
                        name: item.name,
                        emoji: item.emoji || 'üéÅ',
                        rarity: item.rarity || 'common',
                        image: imageUrl,
                        category: itemCategory,
                        description: item.description || item.flavorText || ''
                    });
                }
            });
            
            return prizes;
        }
        
        // Roll a random glow rarity
        async function rollGlow() {
            try {
                const res = await fetch('/api/claw-machine/roll-glow');
                if (res.ok) {
                    const data = await res.json();
                    return data.glow;
                }
            } catch (e) {
                console.error('Failed to roll glow:', e);
            }
            return { rarity: 'none', goldBonus: 0, xpBonus: 0, color: null };
        }
        
        // Track a try used with the server
        async function useATry() {
            try {
                const res = await fetch('/api/claw-machine/use-try', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                if (res.ok) {
                    const data = await res.json();
                    triesRemaining = data.triesRemaining;
                    updateTriesDisplay();
                    return data.canPlay;
                }
            } catch (e) {
                console.error('Failed to track try:', e);
            }
            return true;
        }
        
        // Shuffle the prizes in the machine
        function shufflePrizes() {
            if (clawMachineInstance) {
                const newPrizes = getPrizes();
                clawMachineInstance.shuffleToys(newPrizes);
                console.log('üîÄ Prizes shuffled!');
            }
        }
        
        // Listen for claw button press (try used)
        document.addEventListener('clawTryUsed', async function(e) {
            const canPlay = await useATry();
            
            // Shuffle prizes after first grab
            if (!isFirstGrab) {
                // Shuffle happens after prize is collected, not on try
            } else {
                isFirstGrab = false;
            }
            
            if (!canPlay) {
                alert('No tries remaining for today! Click "End Game" to finish.');
            }
        });
        
        // Listen for prize collection
        document.addEventListener('clawPrizeCollected', async function(e) {
            const prize = e.detail;
            console.log('üéÅ Prize won:', prize);
            
            // Roll a random glow for this prize
            const glow = await rollGlow();
            prize.glow = glow.rarity;
            prize.glowData = glow;
            
            console.log(`‚ú® Prize glow: ${glow.rarity} (${glow.name}) - +${glow.goldBonus} gold, +${glow.xpBonus} XP`);
            
            // Track prize locally
            prizesWon.push(prize);
            
            // Send to server to add to inventory (but don't send Discord message yet)
            try {
                const response = await fetch('/api/claw-machine/prize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        prize: prize,
                        userId: userId,
                        silent: true  // Don't send Discord notification yet
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showPrizeNotification(prize, data.addedToInventory, data.goldBonus, data.xpBonus);
                }
            } catch (error) {
                console.error('Failed to record prize:', error);
                showPrizeNotification(prize, false, 0, 0);
            }
            
            // Shuffle prizes after collecting one
            setTimeout(() => shufflePrizes(), 1500);
        });
        
        // End game and send summary to Discord
        async function endGame() {
            if (prizesWon.length === 0) {
                // No prizes won, just close
                if (confirm('End game without any prizes?')) {
                    window.close();
                    // Fallback if window.close doesn't work
                    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;color:white;font-size:24px;text-align:center;"><div>üé∞ Game Over!<br><br>You can close this tab.</div></div>';
                }
                return;
            }
            
            // Send end session request with summary
            try {
                const response = await fetch('/api/claw-machine/end-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        userId: userId,
                        prizes: prizesWon
                    })
                });
                
                const data = await response.json();
                console.log('Session ended:', data);
            } catch (error) {
                console.error('Failed to end session:', error);
            }
            
            // Show end screen
            document.body.innerHTML = `
                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;color:white;font-size:24px;text-align:center;background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
                    <div style="font-size:48px;margin-bottom:20px;">üéâ</div>
                    <div>Game Over!</div>
                    <div style="font-size:18px;margin-top:10px;opacity:0.8;">You won ${prizesWon.length} prize${prizesWon.length !== 1 ? 's' : ''}!</div>
                    <div style="font-size:14px;margin-top:20px;opacity:0.6;">Check Discord for your summary.<br>You can close this tab.</div>
                </div>
            `;
        }
        
        function showPrizeNotification(prize, addedToInventory, goldBonus = 0, xpBonus = 0) {
            const rarityColors = {
                common: { bg: '#666666', border: '#888888', text: '#cccccc' },
                uncommon: { bg: '#1d6b3a', border: '#2ecc71', text: '#a8e6cf' },
                rare: { bg: '#1a5276', border: '#3498db', text: '#85c1e9' },
                epic: { bg: '#5b2c6f', border: '#9b59b6', text: '#d7bde2' },
                legendary: { bg: '#7d6608', border: '#f1c40f', text: '#f9e79f' },
                mythic: { bg: '#922b21', border: '#e74c3c', text: '#f5b7b1' }
            };
            
            const glowColors = {
                none: null,
                common: '#888888',
                uncommon: '#2ecc71',
                rare: '#3498db',
                epic: '#9b59b6',
                legendary: '#f1c40f',
                mythic: '#e74c3c'
            };
            
            const colors = rarityColors[prize.rarity] || rarityColors.common;
            const rarityName = (prize.rarity || 'common').charAt(0).toUpperCase() + (prize.rarity || 'common').slice(1);
            const description = prize.description || 'A mysterious prize from the claw machine!';
            
            // Glow styling
            const glowRarity = prize.glow || 'none';
            const glowColor = glowColors[glowRarity];
            const glowName = glowRarity !== 'none' ? glowRarity.charAt(0).toUpperCase() + glowRarity.slice(1) + ' Glow' : '';
            const glowStyle = glowColor ? `0 0 30px ${glowColor}, 0 0 60px ${glowColor}44` : '';
            
            // Create pixel-style card - BIGGER VERSION
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 10001;
                animation: pixelPopIn 0.3s ease;
            `;
            notification.innerHTML = `
                <style>
                    @keyframes pixelPopIn {
                        0% { transform: translate(-50%, -50%) scale(0); }
                        60% { transform: translate(-50%, -50%) scale(1.1); }
                        100% { transform: translate(-50%, -50%) scale(1); }
                    }
                    @keyframes sparkle {
                        0%, 100% { opacity: 0.5; transform: scale(1); }
                        50% { opacity: 1; transform: scale(1.05); }
                    }
                    @keyframes glowPulse {
                        0%, 100% { box-shadow: ${glowStyle}; }
                        50% { box-shadow: ${glowColor ? `0 0 60px ${glowColor}, 0 0 100px ${glowColor}66` : 'none'}; }
                    }
                    @keyframes floatUp {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-5px); }
                    }
                    .pixel-card {
                        background: ${colors.bg};
                        border: 6px solid ${glowColor || colors.border};
                        box-shadow: 
                            0 0 0 3px #000,
                            ${glowStyle ? glowStyle + ',' : ''}
                            0 0 40px ${colors.border}66,
                            inset 0 0 30px rgba(0,0,0,0.3);
                        padding: 0;
                        width: 420px;
                        max-width: 95vw;
                        image-rendering: pixelated;
                        font-family: 'Press Start 2P', 'Courier New', monospace;
                        ${glowColor ? 'animation: glowPulse 2s ease-in-out infinite;' : ''}
                    }
                    .pixel-card-header {
                        background: linear-gradient(180deg, ${glowColor || colors.border} 0%, ${colors.bg} 100%);
                        padding: 14px 18px;
                        border-bottom: 3px solid #000;
                        text-align: center;
                        font-size: 16px;
                        color: #fff;
                        text-shadow: 3px 3px 0 #000;
                        letter-spacing: 2px;
                    }
                    .pixel-card-body {
                        padding: 25px;
                        text-align: center;
                    }
                    .pixel-card-image {
                        width: 120px;
                        height: 120px;
                        margin: 0 auto 15px;
                        image-rendering: pixelated;
                        filter: drop-shadow(4px 4px 0 #000) ${glowColor ? `drop-shadow(0 0 15px ${glowColor})` : ''};
                        animation: floatUp 2s ease-in-out infinite;
                    }
                    .pixel-card-image img {
                        width: 100%;
                        height: 100%;
                        object-fit: contain;
                    }
                    .pixel-card-emoji {
                        font-size: 96px;
                        margin-bottom: 15px;
                        filter: drop-shadow(4px 4px 0 #000) ${glowColor ? `drop-shadow(0 0 15px ${glowColor})` : ''};
                        animation: floatUp 2s ease-in-out infinite;
                    }
                    .pixel-card-name {
                        font-size: 16px;
                        color: #fff;
                        text-shadow: 3px 3px 0 #000;
                        margin-bottom: 12px;
                        line-height: 1.5;
                    }
                    .pixel-card-rarity {
                        font-size: 12px;
                        color: ${colors.text};
                        text-shadow: 2px 2px 0 #000;
                        margin-bottom: 10px;
                        padding: 6px 14px;
                        background: rgba(0,0,0,0.3);
                        display: inline-block;
                        border: 2px solid ${colors.border};
                    }
                    .pixel-card-glow {
                        font-size: 12px;
                        color: ${glowColor || '#888'};
                        text-shadow: 2px 2px 0 #000, ${glowColor ? `0 0 15px ${glowColor}` : 'none'};
                        margin-bottom: 15px;
                        padding: 8px 14px;
                        background: rgba(0,0,0,0.5);
                        display: inline-block;
                        border: 2px solid ${glowColor || '#444'};
                        animation: sparkle 1.5s ease-in-out infinite;
                    }
                    .pixel-card-bonus {
                        font-size: 14px;
                        color: #ffd700;
                        text-shadow: 2px 2px 0 #000;
                        margin-bottom: 15px;
                        padding: 10px 16px;
                        background: rgba(255, 215, 0, 0.15);
                        border: 2px solid #ffd700;
                        display: inline-block;
                    }
                    .pixel-card-desc {
                        font-size: 11px;
                        color: ${colors.text};
                        text-shadow: 1px 1px 0 #000;
                        line-height: 1.8;
                        font-style: italic;
                        padding: 14px;
                        background: rgba(0,0,0,0.25);
                        border: 3px solid rgba(0,0,0,0.4);
                        margin-top: 10px;
                    }
                    .pixel-card-footer {
                        background: rgba(0,0,0,0.4);
                        padding: 12px 18px;
                        border-top: 3px solid #000;
                        text-align: center;
                        font-size: 12px;
                        color: #90EE90;
                        text-shadow: 2px 2px 0 #000;
                    }
                </style>
                <div class="pixel-card">
                    <div class="pixel-card-header">‚òÖ PRIZE WON! ‚òÖ</div>
                    <div class="pixel-card-body">
                        ${prize.image 
                            ? `<div class="pixel-card-image"><img src="${prize.image}" alt="${prize.name}"></div>`
                            : `<div class="pixel-card-emoji">${prize.emoji || 'üéÅ'}</div>`
                        }
                        <div class="pixel-card-name">${prize.name}</div>
                        <div class="pixel-card-rarity">[ ${rarityName} ]</div>
                        ${glowName ? `<div class="pixel-card-glow">‚ú® ${glowName} ‚ú®</div>` : ''}
                        ${(goldBonus > 0 || xpBonus > 0) ? `<div class="pixel-card-bonus">+${goldBonus} ü™ô Gold | +${xpBonus} ‚≠ê XP</div>` : ''}
                        <div class="pixel-card-desc">"${description}"</div>
                    </div>
                    ${addedToInventory ? '<div class="pixel-card-footer">‚úì ADDED TO INVENTORY</div>' : ''}
                </div>
            `;
            
            // Add click to dismiss
            notification.onclick = () => {
                notification.style.transition = 'all 0.2s ease';
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
                setTimeout(() => notification.remove(), 200);
            };
            
            document.body.appendChild(notification);
            
            // Auto-dismiss after 4 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.transition = 'all 0.3s ease';
                    notification.style.opacity = '0';
                    notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }
        
        // Listen for game events
        document.addEventListener('clawNoTriesLeft', function() {
            alert('No tries remaining! Click "End Game" to finish.');
        });
        
        document.addEventListener('clawSlipped', function() {
            console.log('Prize slipped!');
        });
        
        // Start initialization
        init();
    </script>
</body>
</html>